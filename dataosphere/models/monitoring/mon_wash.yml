version: 2

models:
  - name: mon_rejections_by_model_day
    description: |
      Daily rejection counts by model, derived from each model’s rejected/quarantine output.
      Grain: 1 row per (base_model_name, event_date).
      Purpose: Operational monitoring to track where bad records are occurring over time and to support fast triage.
      Notes: base_model_name is the canonical model identifier (e.g., stg_kobo_household) derived from a naming convention like <base>__rejected.

    config:
      tags: ["monitoring", "wash", "kobo"]

    data_tests:
      - dbt_utils.unique_combination_of_columns:
          arguments:
            description: "Enforce monitoring grain: only one rejection count per base model per day."
            combination_of_columns:
              - base_model_name
              - event_date
          config:
            severity: error
            store_failures: true

    columns:
      - name: base_model_name
        description: |
          Canonical model identifier used to group related model variants (e.g., __base, __rejected) under one name.
          Example: stg_kobo_household from stg_kobo_household__rejected.
        data_tests:
          - not_null:
              config:
                severity: warn
                store_failures: true

      - name: event_date
        description: |
          Reporting date used for daily monitoring aggregation.
          Must be derived consistently across monitoring models (same timezone + same date logic).
        data_tests:
          - not_null:
              config:
                severity: warn
                store_failures: true

      - name: rejected_row_count
        description: |
          Count of rejected/quarantined rows for the model on the given event_date.
          Used as the numerator for rejection-rate monitoring.
        data_tests:
          - not_null:
              config:
                severity: warn
                store_failures: true

  - name: mon_total_by_model_day
    description: |
      Daily base-row counts by model (the total rows produced by the “base/accepted” model for that day).
      Grain: 1 row per (base_model_name, event_date).
      Purpose: Provides the denominator for rejection-rate monitoring and a baseline volume trend per model.

    config:
      tags: ["monitoring", "wash", "kobo"]

    data_tests:
      - dbt_utils.unique_combination_of_columns:
          arguments:
            description: "Enforce monitoring grain: only one base-row count per base model per day."
            combination_of_columns:
              - base_model_name
              - event_date
          config:
            severity: error
            store_failures: true

    columns:
      - name: base_model_name
        description: |
          Canonical model identifier used to group related model variants (e.g., __base, __rejected) under one name.
          Example: stg_kobo_household from stg_kobo_household__base.
        data_tests:
          - not_null:
              config:
                severity: warn
                store_failures: true

      - name: event_date
        description: |
          Reporting date used for daily monitoring aggregation.
          Must be derived consistently across monitoring models (same timezone + same date logic).
        data_tests:
          - not_null:
              config:
                severity: warn
                store_failures: true

      - name: base_row_count
        description: |
          Count of base/accepted rows produced by the model on the given event_date.
          Used as the denominator for rejection-rate monitoring.
        data_tests:
          - not_null:
              config:
                severity: warn
                store_failures: true

  - name: mon_rejection_rate_day
    description: |
      Daily rejection rate by model.
      Grain: 1 row per (model_name, event_date) or (base_model_name, event_date) depending on how the model is implemented.
      Purpose: Monitoring view to quickly identify models/days with unusually high rejection proportions.
      Definition: rejection_rate = rejected_row_count / base_row_count (with safe division rules).

    config:
      tags: ["monitoring", "wash", "kobo"]

    data_tests:
      - dbt_utils.unique_combination_of_columns:
          arguments:
            description: "Ensure only one rejection-rate record exists per model per day."
            combination_of_columns:
              - model_name
              - event_date
          config:
            severity: warn
            store_failures: true

      - dbt_utils.expression_is_true:
          arguments:
            description: "Sanity check: base row count must be non-negative."
            expression: "base_row_count >= 0"
          config:
            severity: warn
            store_failures: true

      - dbt_utils.expression_is_true:
          arguments:
            description: "Sanity check: rejected row count must be non-negative."
            expression: "rejected_row_count >= 0"
          config:
            severity: warn
            store_failures: true

      - dbt_utils.expression_is_true:
          arguments:
            description: "Sanity check: rejection rate must fall between 0 and 1 (inclusive)."
            expression: "rejection_rate between 0 and 1"
          config:
            severity: warn
            store_failures: true

      - dbt_utils.expression_is_true:
          arguments:
            description: "Logical constraint: rejected rows cannot exceed base rows for the same model/day."
            expression: "rejected_row_count <= base_row_count"
          config:
            severity: warn
            store_failures: true

    columns:
      - name: model_name
        description: |
          Model identifier used in this monitoring output (may be the physical model name or the canonical base_model_name).
          Must align with the grain enforced in tests.
        data_tests:
          - not_null:
              config:
                severity: warn
                store_failures: true

      - name: event_date
        description: |
          Reporting date used for daily monitoring aggregation.
          Must be derived consistently across monitoring models.
        data_tests:
          - not_null:
              config:
                severity: warn
                store_failures: true

      - name: base_row_count
        description: |
          Total base/accepted rows for the model/day (denominator).
        data_tests:
          - not_null:
              config:
                severity: warn
                store_failures: true

      - name: rejected_row_count
        description: |
          Total rejected/quarantined rows for the model/day (numerator).
        data_tests:
          - not_null:
              config:
                severity: warn
                store_failures: true

      - name: rejection_rate
        description: |
          Share of rows rejected for the model/day.
          Computed as rejected_row_count / base_row_count (using safe division rules such as div0).
        data_tests:
          - not_null:
              config:
                severity: warn
                store_failures: true

  - name: mon_unknown_diarrhoea_rate_ward_day
    description: |
      Daily monitoring view for diarrhoea-response completeness by ward.
      Grain: 1 row per (ward_id, event_date).
      Purpose: Quantifies how often member diarrhoea status is recorded as 'unknown' so data collectors and analysts can spot ward/day patterns in missingness and follow up operationally.
      Interpretation: A higher unknown rate indicates weaker survey completeness or data capture issues for diarrhoea reporting, and should trigger triage before using downstream “safe drinking water” KPIs.

    config:
      tags: ["monitoring", "wash", "kobo"]
      
    data_tests:
      - dbt_utils.unique_combination_of_columns:
          arguments:
            description: "Ensure only one unknown-rate record exists per model per day."
            combination_of_columns:
              - ward_id
              - event_date
          config:
            severity: warn
            store_failures: true

      - dbt_utils.expression_is_true:
          arguments:
            description: "Sanity check: unknown diarrhoea count must be non-negative."
            expression: "unknown_diarrhoea_count >= 0"
          config:
            severity: warn
            store_failures: true


      - dbt_utils.expression_is_true:
          arguments:
            description: "Sanity check: unknown rate must fall between 0 and 1 (inclusive)."
            expression: "unknown_rate between 0 and 1"
          config:
            severity: warn
            store_failures: true


  - name: mon_rejection_by_reason_day
    description: |
      Daily rejection counts by model and reason bucket.
      Grain: 1 row per (model_name, base_model_name, event_date, reason_bucket).
      Purpose: Provides the “why” slicer for DQ monitoring so teams can quickly see whether rejections are driven by missing keys, orphan FKs, invalid canonical values, invalid ranges, unknown/other categories, soft deletes, or other issues.
      Notes: reason_bucket is derived from model-specific DQ flags inside each <base>__rejected model. Only one bucket is assigned per rejected row based on precedence.

    config:
      tags: ["monitoring", "wash", "kobo"]

    data_tests:
      - dbt_utils.unique_combination_of_columns:
          arguments:
            description: "Enforce monitoring grain: only one rejected_rows value per (model_name, event_date, reason_bucket)."
            combination_of_columns:
              - base_model_name
              - event_date
              - reason_bucket
          config:
            severity: error
            store_failures: true

      - dbt_utils.expression_is_true:
          arguments:
            description: "Sanity check: rejected_rows must be non-negative."
            expression: "rejected_rows >= 0"
          config:
            severity: warn
            store_failures: true

    columns:
      - name: base_model_name
        description: |
          Canonical base model identifier derived from the rejected model naming convention.
          Example: stg_kobo_household from stg_kobo_household__rejected.
          Used to align rejected/base counts across monitoring models.
        data_tests:
          - not_null:
              config:
                severity: warn
                store_failures: true

      - name: event_date
        description: |
          Reporting date for monitoring aggregation, derived from record_loaded_at.
          Used as the day grain for rejections trending.
        data_tests:
          - not_null:
              config:
                severity: warn
                store_failures: true

      - name: reason_bucket
        description: |
          Standardised rejection reason category (one per rejected row, based on precedence).
          Allowed buckets:
            - missing_keys
            - orphan_fk
            - invalid_required_field
            - invalid_canonical
            - invalid_range
            - unknown_other
            - soft_deleted
            - other
        data_tests:
          - not_null:
              config:
                severity: warn
                store_failures: true
          - accepted_values:
              arguments:
                values:
                  - missing_keys
                  - orphan_fk
                  - invalid_required_field
                  - invalid_canonical
                  - invalid_range
                  - unknown_other
                  - soft_deleted
                  - other
              config:
                severity: warn
                store_failures: true

      - name: rejected_rows
        description: |
          Count of rejected/quarantined rows for the given (model_name, event_date, reason_bucket).
          Supports slice-and-dice debugging of rejection drivers over time.
        data_tests:
          - not_null:
              config:
                severity: warn
                store_failures: true

  - name: mon_late_arrival_rate_ward_day
    description: |
      Ward-by-day monitoring table that quantifies late-arriving survey records.
      A record is considered “late” when its event time (submitted_at) falls on an
      earlier date than its warehouse load time (record_loaded_at). This is used
      to spot enumeration / sync delays, identify wards with reporting lag, and
      explain shifts between survey rounds without touching KPI logic.

    config:
      tags: ["monitoring", "wash", "kobo"]

    tests:
      - dbt_utils.expression_is_true:
          arguments:
            expression: "late_arrival_rate between 0 and 1"

