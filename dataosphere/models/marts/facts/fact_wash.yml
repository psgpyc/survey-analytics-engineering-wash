version: 2

models:
  - name: fact_household_wash_event
    description: |
      Household-level WASH fact table at survey-event grain.
      Grain: 1 row per (household_id, submission_id).
      Purpose: Provides the KPI-ready event record to report “safe drinking water households” by ward and time period.
      KPI flag: is_safe_drinking is derived from safe source + safe treatment + no diarrhoea (14 days) rules.

    config:
      tags: ['mart', 'fact' ,'wash', 'kobo']
    
    data_tests:
      - dbt_utils.unique_combination_of_columns:
          arguments:
            description: "Enforce declared grain: each household survey event must be unique at (household_id × submission_id)."
            combination_of_columns:
              - household_id
              - submission_id
          config:
            severity: error
            store_failures: true

      - dbt_utils.expression_is_true:
          arguments:
            description: "KPI contract check: is_safe_drinking must exactly equal the AND of its three input flags (no hidden logic drift)."
            expression: "is_safe_drinking = (has_safe_primary_source and has_safe_water_filter and has_no_diarrhoea_14d_members)"
          config:
            severity: error
            store_failures: true

      - dbt_utils.expression_is_true:
          arguments:
            description: "Fact eligibility rule: only include household-events where at least one household member record exists for the event."
            expression: "member_count >= 1"
          config:
            severity: error
            store_failures: true

    columns:
      - name: household_id
        description: |
          Household identifier as captured in the survey instrument.
          Part of the primary key for this fact table and used to join to downstream household-level reporting entities.
        data_tests:
          - not_null:
              config:
                severity: error
                store_failures: true

      - name: submission_id
        description: |
          Submission event identifier (FK to the submitted survey event).
          Part of the primary key for this fact table and provides event-time context for period-based reporting.
        data_tests:
          - not_null:
              config:
                severity: error
                store_failures: true

      - name: has_safe_water_filter
        description: |
          Derived flag indicating whether the household’s reported water treatment / filter type is classified as “safe”
          according to the project’s SAFE_WATER_FILTER_TYPES contract.
        data_tests:
          - not_null:
              config:
                severity: error
                store_failures: true

      - name: has_safe_primary_source
        description: |
          Derived flag indicating whether the household’s primary drinking water source is classified as “safe”
          according to the project’s SAFE_PRIMARY_WATER_SOURCES contract.
        data_tests:
          - not_null:
              config:
                severity: error
                store_failures: true

      - name: is_safe_drinking
        description: |
          Final KPI flag for safe drinking water at household-event grain.
          True only when: safe primary source AND safe treatment/filter AND no diarrhoea in last 14 days members.
        data_tests:
          - not_null:
              config:
                severity: error
                store_failures: true

  - name: fact_agg_safe_drinking_ward_day
    description: |
      Ward-by-day aggregate mart for safe drinking water reporting.
      Grain: 1 row per (ward_id, event_date).
      Purpose: Provides daily ward-level totals and safe counts derived from fact_household_wash_event,
      so BI tools can consume a pre-aggregated, KPI-ready dataset without re-implementing business logic.
      Notes: event_date is derived from submitted_at (survey-event timestamp) in the upstream fact.

    config:
      tags: ['mart', 'fact' ,'wash', 'kobo']

    data_tests:
      - dbt_utils.unique_combination_of_columns:
          arguments:
            description: "Enforce declared grain: each ward/day combination must be unique."
            combination_of_columns: 
              - ward_id
              - event_date
          config:
            severity: error
            store_failures: true

      - dbt_utils.expression_is_true:
          arguments:
            description: "Sanity check: safe household-events cannot exceed total household-events within the same ward/day."
            expression: "household_events_safe <= household_events_total"
          config:
            severity: error
            store_failures: true

      - dbt_utils.expression_is_true:
          arguments:
            description: "Sanity check: pct_safe must be a valid proportion between 0 and 1 (inclusive)."
            expression: "pct_safe between 0 and 1"
          config:
            severity: error
            store_failures: true

    columns:
      - name: ward_id
        description: |
          Ward identifier used for geographic aggregation.
          This is the reporting slice for ward-level WASH indicators.
        data_tests:
          - not_null:
              config:
                severity: error
                store_failures: true
      
      - name: event_date
        description: |
          Survey event date derived from the submission timestamp (submitted_at) in the upstream fact.
          Defines the daily reporting period for ward-level KPI aggregation.
        data_tests:
          - not_null:
              config:
                severity: error
                store_failures: true

      - name: household_events_total
        description: |
          Total number of household survey events recorded for the ward on the given event_date.
          Denominator for pct_safe.
        data_tests:
          - not_null:
              config:
                severity: error
                store_failures: true

      - name: household_events_safe
        description: |
          Number of household survey events classified as safe drinking water for the ward on the given event_date.
          Numerator for pct_safe.
        data_tests:
          - not_null:
              config:
                severity: error
                store_failures: true

      - name: pct_safe
        description: |
          Proportion of safe household survey events for the ward and event_date.
          Computed as household_events_safe / household_events_total (with zero-safe handling upstream).
        data_tests:
          - not_null:
              config:
                severity: error
                store_failures: true

  - name: fact_household_wash_event_enriched_scd2
    description: |
      Household-event fact enriched with point-in-time household attributes from the SCD2 household snapshot.
      Grain: 1 row per (household_id, submission_id).
      Purpose: Enables historically correct slicing of events by household attributes (filter/source/toilet/size, district/municipality)
      as-of the event timestamp (event_ts).

    config:
      tags: ['mart', 'fact' ,'wash', 'kobo']

    data_tests:
      - dbt_utils.unique_combination_of_columns:
          arguments:
            description: "Enforce declared grain: one enriched row per household survey event."
            combination_of_columns:
              - household_id
              - submission_id
          config:
            severity: error
            store_failures: true

      - dbt_utils.expression_is_true:
          arguments:
            description: |
              Point-in-time join correctness: when a snapshot row is present, the event timestamp must fall within the snapshot validity window.
            expression: >
              dbt_valid_from is null
              or (
                submitted_at >= dbt_valid_from
                and (dbt_valid_to is null or submitted_at < dbt_valid_to)
              )
          config:
            severity: error
            store_failures: true

    columns:
      - name: household_id
        description: "Household identifier. Part of the primary key for the household-event grain."
        data_tests:
          - not_null:
              config: {severity: error, store_failures: true}

      - name: submission_id
        description: "Submission identifier for the survey event. Part of the primary key for the household-event grain."
        data_tests:
          - not_null:
              config: {severity: error, store_failures: true}

      - name: dbt_valid_from
        description: "Snapshot validity start timestamp for the household attributes row matched to the event."

      - name: dbt_valid_to
        description: "Snapshot validity end timestamp for the household attributes row matched to the event (null = current row)."

    
