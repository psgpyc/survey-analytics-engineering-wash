version: 2

models:
  - name: int_household_event
    description: |
      Household survey event table combining household responses with submission context.
      Grain: 1 row per (household_id, submission_id). Assumes upstream staging models are already deduped and relationship-tested.
      Purpose: Provides the event-scoped household record used to build downstream facts/KPIs (e.g., safe drinking water by ward and period).
      Primary Key: household_id, submission_id.
      Relationship notes: submission_id links to the submission event; ward_id and submitted_at are sourced from the submission model to support geographic and time-based reporting.

    config:
      tags: ['int', 'wash', 'kobo']

    data_tests:
      - dbt_utils.unique_combination_of_columns:
          arguments:
            combination_of_columns:
              - household_id
              - submission_id
          config:
            severity: error
            store_failures: true

    columns:
      - name: household_id
        description: |
          Household identifier as captured in the survey instrument.
          This is the core household entity key used to join household-level attributes and to roll up member outcomes for household KPIs.
        data_tests:
          - not_null:
              config:
                severity: error
                store_failures: true

      - name: submission_id
        description: |
          Submission event identifier (FK to stg_kobo_submission.submission_id).
          Represents the specific survey submission instance in which this household record was captured (supports repeated/incremental survey waves per household).
        data_tests:
          - not_null:
              config:
                severity: error
                store_failures: true
          - relationships:
              arguments:
                to: ref('stg_kobo_submission')
                field: submission_id
              config:
                severity: error
                store_failures: true

      - name: ward_id
        description: |
          Ward identifier associated with the submission event (source of truth: submission).
          Used for ward-level aggregation and geographic disaggregation of WASH indicators.
        data_tests:
          - not_null:
              config:
                severity: error
                store_failures: true

      - name: submitted_at
        description: |
          Timestamp when the submission was recorded as submitted (device/user submit time as standardised in staging).
          Used as the event timestamp for period-based reporting (daily/weekly/monthly) and time-windowed KPI calculations.
        data_tests:
          - not_null:
              config:
                severity: error
                store_failures: true

  - name: int_submission_submitted
    description: |
      Submitted-only submission events.
      Grain: 1 row per submission_id.
      Purpose: Provides the “reportable submission” contract (status='submitted') for downstream joins and KPI models,
      so draft/incomplete submissions are excluded from analytical reporting.
      Notes: Downstream models that represent official counts or time-based KPIs should join to this model (or filter equivalently).

    config:
      tags: ['int', 'wash', 'kobo']

    data_tests:
      - dbt_utils.expression_is_true:
          arguments:
            expression: "status = 'submitted'"
          config:
            severity: error
            store_failures: true

    columns:
      - name: submission_id
        description: |
          Primary key for a submitted submission event.
          Unique identifier for the submission instance used as the join key for event-scoped household, member, and water point records.
        data_tests: 
          - not_null:
              config:
                severity: error
                store_failures: true
          - unique:
              config:
                severity: error
                store_failures: true

  - name: int_household_member_health_rollup
    description: |
      Household-level member health rollup derived from the member repeat-group.
      Grain: 1 row per (household_id, submission_id).
      Purpose: Aggregates member roster health outcomes to the household submission event level,
      enabling household KPIs such as “no diarrhoea reported in last 14 days” to be computed reliably.
      Notes: This model is intended to be joined into household event/fact tables using (household_id, submission_id).

    config:
      tags: ['int', 'wash', 'kobo']
    
    data_tests:
      - dbt_utils.unique_combination_of_columns:
          arguments:
            combination_of_columns:
              - household_id
              - submission_id
          config:
            severity: error
            store_failures: true

      - dbt_utils.expression_is_true:
          arguments:
            expression: "total_diarrhoea_case_count_14d >= 0 and total_diarrhoea_case_count_14d <= member_count "
          config:
            severity: error
            store_failures: true

    columns:
      - name: household_id
        description: |
          Household identifier (FK to household grain in staging).
          Used with submission_id to anchor member rollups to a specific household survey event.
        data_tests:
          - not_null:
              config:
                severity: error
                store_failures: true

      - name: submission_id
        description: |
          Submission identifier (FK to submission events).
          Ensures member rollups are scoped to the specific submission wave in which the roster and health responses were captured.
        data_tests:
          - not_null:
              config:
                severity: error
                store_failures: true

      - name: member_count
        description: |
          Count of distinct household members captured in the submission (based on member_index).
          Represents the roster size used as the denominator for household-level member-derived health metrics.
        data_tests:
          - not_null:
              config:
                severity: error
                store_failures: true

      - name: total_diarrhoea_case_count_14d
        description: |
          Number of household members reported as having diarrhoea in the last 14 days for this submission event.
          Used to derive household flags such as “has any diarrhoea” and “has no diarrhoea” in downstream KPI logic.
        data_tests:
          - not_null:
              config:
                severity: error
                store_failures: true

      - name: has_no_diarrhoea_14d_members
        description: |
          Number of household members reported as having diarrhoea in the last 14 days for this submission event.
        data_tests:
          - not_null:
              config:
                severity: error
                store_failures: true

  - name: int_household_safe_inputs
    description: |
      Intermediate “safe drinking water” input table at household-event grain.
      Grain: 1 row per (household_id, submission_id).
      Purpose: Provides the minimum set of standardised and rolled-up fields required to compute the downstream safe drinking water KPI
      (e.g., safe source, safe filter, and diarrhoea-based household health condition) by ward and reporting period.
      Notes:
        - Only includes household-events with an associated member roster (inner-join contract).
        - Assumes upstream staging models enforce typing, deduplication, and soft-delete handling.

    config:
      tags: ['int', 'wash', 'kobo']
    
    data_tests:
      - dbt_utils.unique_combination_of_columns:
          arguments:
            combination_of_columns:
              - household_id
              - submission_id
          config:
            severity: error
            store_failures: true

      - dbt_utils.expression_is_true:
          arguments:
            description: |
              Ensure diarrhoea tri-state rollup is internally consistent: the household member_count equals the sum of yes/no/unknown counts.
              This prevents double-counting and validates that every member record contributes exactly one diarrhoea status.
            expression: "member_count = (total_diarrhoea_case_count_14d + total_unknown_diarrhoea_count_14d + total_no_diarrhoea_count_14d)"
          config:
            severity: error
            store_failures: true
      
      - dbt_utils.expression_is_true:
          arguments:
            description: |
              Enforce “no diarrhoea” household rule: the flag must be true only when there are zero 'yes' cases and zero 'unknown' cases,
              and all recorded member statuses are 'no'. This ensures we never classify a household as safe when diarrhoea status is unknown.
            expression: "has_no_diarrhoea_14d_members = ((total_diarrhoea_case_count_14d = 0 and total_unknown_diarrhoea_count_14d = 0) and (total_no_diarrhoea_count_14d = member_count))"
          config:
            severity: error
            store_failure: true

    columns:
      - name: household_id
        description: |
          Household identifier as captured in the survey instrument.
          Part of the declared grain for this model and the primary join key to household-level attributes and downstream household facts.
        data_tests: 
          - not_null:
              config:
                severity: error
                store_failures: true

      - name: submission_id
        description: |
          Submission event identifier representing the specific survey wave/instance in which the household record was captured.
          Part of the declared grain for this model and used to support period-based reporting (via submitted_at/collection time in upstream models).
        data_tests:
          - not_null:
              config:
                severity: error
                store_failures: true

      - name: has_no_diarrhoea_14d_members
        description: |
          Household-level derived flag indicating that no household members reported diarrhoea in the last 14 days
          and that there are no unknown diarrhoea statuses within the household roster for this submission.
          This field is a key input to the downstream “safe drinking water household” classification.
        data_tests: 
          - not_null:
              config:
                severity: error
                store_failures: true

      




